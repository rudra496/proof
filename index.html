<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Private File Upload (Supabase)</title>
  <style>
    :root {
      color-scheme: light dark;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }
    body {
      margin: 0;
      min-height: 100vh;
      display: grid;
      place-items: center;
      background: #0b1020;
      color: #e7eaf3;
    }
    .card {
      width: min(92vw, 520px);
      background: #111831;
      border: 1px solid #2b355f;
      border-radius: 14px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,.3);
    }
    h1 {
      margin: 0 0 12px;
      font-size: 1.1rem;
    }
    p {
      margin: 0 0 16px;
      opacity: .9;
      font-size: .95rem;
      line-height: 1.4;
    }
    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin: 12px 0;
    }
    input[type="file"] {
      width: 100%;
      padding: 8px;
      border: 1px dashed #42508e;
      border-radius: 10px;
      background: #0f1630;
      color: inherit;
    }
    button {
      border: 0;
      border-radius: 10px;
      padding: 10px 14px;
      font-weight: 600;
      cursor: pointer;
      background: #4c72ff;
      color: white;
    }
    button.secondary {
      background: #2f3b66;
    }
    button:disabled {
      opacity: .6;
      cursor: not-allowed;
    }
    #status {
      margin-top: 10px;
      padding: 10px;
      border-radius: 10px;
      background: #0f1630;
      border: 1px solid #2b355f;
      white-space: pre-wrap;
      word-break: break-word;
      font-size: .9rem;
      min-height: 24px;
    }
  </style>
</head>
<body>
  <main class="card">
    <h1>Private Upload (Supabase Storage)</h1>
    <p>
      Uploads go to private bucket <code>uploads</code>. Files are opened only with short-lived signed URLs.
    </p>

    <input id="fileInput" type="file" />

    <div class="row">
      <button id="uploadBtn" type="button">Upload File</button>
      <button id="openBtn" type="button" class="secondary" disabled>Open Uploaded File (Signed URL)</button>
    </div>

    <div id="status" role="status" aria-live="polite"></div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Supabase "anon" key is safe in frontend apps by design.
    // It does NOT bypass RLS. Your Storage policies still enforce what this page can do.
    const SUPABASE_URL = 'https://voljywzegdgxxcvymlhp.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_5xMvlF8dkzsKSjNYe_8lZg_HPVivB7R';
    const BUCKET = 'uploads';

    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const fileInput = document.getElementById('fileInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const openBtn = document.getElementById('openBtn');
    const statusEl = document.getElementById('status');

    let uploadedPath = null;

    function setStatus(message, isError = false) {
      statusEl.textContent = message;
      statusEl.style.borderColor = isError ? '#a43f5d' : '#2b355f';
    }

    function createUniquePath(file) {
      const safeName = file.name.replace(/[^a-zA-Z0-9._-]/g, '_');
      const ext = safeName.includes('.') ? safeName.split('.').pop() : 'bin';
      const base = safeName.replace(/\.[^.]+$/, '');
      const unique = `${Date.now()}-${crypto.randomUUID()}`;
      return `${unique}-${base}.${ext}`;
    }

    async function uploadFile(file) {
      if (!file) throw new Error('Please choose a file first.');

      const path = createUniquePath(file);

      const { data, error } = await supabaseClient.storage
        .from(BUCKET)
        .upload(path, file, {
          cacheControl: '3600',
          upsert: false,
          contentType: file.type || 'application/octet-stream'
        });

      if (error) {
        throw new Error(`Upload failed: ${error.message}`);
      }

      return data.path;
    }

    async function openFileWithSignedUrl(path) {
      if (!path) throw new Error('No uploaded file path found yet.');

      // Bucket is private, so public URLs are intentionally NOT used.
      // Signed URLs are required to grant temporary, controlled access.
      const { data, error } = await supabaseClient.storage
        .from(BUCKET)
        .createSignedUrl(path, 60);

      if (error || !data?.signedUrl) {
        throw new Error(`Signed URL error: ${error?.message || 'No signed URL returned.'}`);
      }

      const opened = window.open(data.signedUrl, '_blank', 'noopener,noreferrer');
      if (!opened) {
        throw new Error('Popup blocked. Allow popups for this site and try again.');
      }
    }

    uploadBtn.addEventListener('click', async () => {
      uploadBtn.disabled = true;
      openBtn.disabled = true;
      setStatus('Uploading...');

      try {
        const file = fileInput.files?.[0];
        uploadedPath = await uploadFile(file);
        openBtn.disabled = false;
        setStatus(`Upload successful.\nStored path: ${uploadedPath}`);
      } catch (err) {
        uploadedPath = null;
        setStatus(err.message || 'Unknown upload error.', true);
      } finally {
        uploadBtn.disabled = false;
      }
    });

    openBtn.addEventListener('click', async () => {
      openBtn.disabled = true;
      setStatus('Creating signed URL...');

      try {
        await openFileWithSignedUrl(uploadedPath);
        setStatus('Signed URL created. File opened in a new tab (valid for 60 seconds).');
      } catch (err) {
        setStatus(err.message || 'Could not open file with signed URL.', true);
      } finally {
        openBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
